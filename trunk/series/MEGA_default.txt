%%
%% MegaPlot Components
%%

%% Similar to quests, but work for plots.

%%
%% *:CrookedCorpo Content
%%
%%  A local businessperson is breaking the law. Your task is to uncover the
%%  evidence which will prove this... or, maybe accept a bribe to keep the
%%  whole thing quiet.
%%
%% PARAM1: The character under investigation
%%

Content
	name <>

%%
%% *:ReconBeefgate Content
%%
%%  You're searching for a team of mecha, but the final encounter is probably
%%  too difficult for the PC as of yet. What to do? The answer, of course, is to
%%  install a beefgate. The PC will be sent to fight successively harder waves
%%  of enemies until the final battle is unveiled.
%%
%%  Note that %name3% will be used as the title of what you're looking for, so
%%  name your encounter accordingly.
%%
%% PARAM1: The Mission-Giver
%% PARAM2: The outdoor scene where scene-to-reveal is
%% PARAM3: Scene-to-reveal
%% PARAM4: The faction of the beef

Content
	name <Recon Beefgate>
	requires <*:ReconBeefgate>
	desc <Pound the beefgate until it spits up an encounter.>

	% E1 is the mission-giver
	% E2 is the outdoors scene
	% E3 is the scene to be revealed
	% E4 is the enemy faction
	% E5 is the beefgate itself
	Element5 <Prefab>
	Place5 <2>

	% P%id%01 = BeefGate Appearance Timer
	% P%id%02 = BeefGate Difficulty Rating
	% P%id%03 = Number of wins against the beefgate
	% P%id%04 = Number of wins rewarded

	% This script handles the recharge if E1 is dead.
	hour <ifNPCDead %1% ifG P%id%03 P%id%04   P= %id%01 ComTime P+ %id%01 d7200 P+ %id%01 3600 P= %id%03 P%id%04>

	sub
		Persona 1
		% V%id%01 = Next Mission Counter
		greeting <if= PlotStatus %plotid% %id% else %pop% ifG P%id%03 P%id%04 else .%id%_GoCheckNext P= %id%03 P%id%04  ifG p%id%02 %threat% else .%id%_GoMinorVictory Goto .%id%_GoMajorVictory>
		.%id%_GoMajorVictory <NewChat Say %id%01 CashPrize Reward P%id%02 100  SetEncounterActive %3%  WinSubPlot %plotid%>
		.%id%_GoMinorVictory <NewChat Say %id%02 CashPrize Reward P%id%02 80   V= %id%01 ComTime V+ %id%01 3600 V+ %id%01 d7200>
		.%id%_GoCheckNext <if# v%id%01 0 else .%id%_GoCheckProgress ifG ComTime v%id%01 else .%id%_GoWaitNextMission  NewChat Say %id%03  Goto .%id%_GoActivateBeefgate>
		.%id%_GoActivateBeefgate <P= %id%01 ComTime V= %id%01 0 ifG PCRenown p%id%02 P= %id%02 PCRenown>
		.%id%_GoWaitNextMission <NewChat Say %id%04>
		.%id%_GoCheckProgress <if# P%id%01 0 else .%id%_GoFirstTime NewChat Say %id%05>
		*.%id%_GoFirstTime <*IHaveAJobForYou .%id%_GoBriefing>
		.%id%_GoBriefing <NewChat Say %id%06 AddChat %id%01 AddChat %id%02>
		result%id%01 <NewChat Say %id%07 PMemo %plotid% %id%08  Goto .%id%_GoActivateBeefgate>
		result%id%02 <NewChat Say %id%09>
		Msg%id%01 <You did it! Based on the data you've returned, we've located %name3%. These coordinates should bring you right there.>
		Msg%id%02 <Good work, \PC . We still haven't located %name3% , but come back in a few hours and we may be closer.>
		Msg%id%03 <We've found another lance from %name4% operating in \EXACT_SCENE %2% . I'd like for you to go engage them... The data you bring back might help us to locate %name3%.>
		Msg%id%04 <Come back in a few hours and I may have another mission for you.>
		Msg%id%05 <The mecha from %name4% are still operating in \EXACT_SCENE %2% . Come back after you've defeated them.>
		Msg%id%06 <I've been tasked with locating %name3%. Now, there are some mecha in \EXACT_SCENE %2% from %name4%; if you were to engage them, we might be able to learn something.>
		Msg%id%07 <Great! These coordinates will take you straight to their position... Good luck, \PC .>
		Msg%id%08 <%name1% sent you to fight some mecha in \EXACT_SCENE %2% so you can locate %name3%.>
		Msg%id%09 <Well, if you change your mind, I'll be right here.>
		Prompt%id%01 <I'll go see what I can do.>
		Prompt%id%02 <No, I don't want to.>

		MetaScene 5 2
		special <UNCHARTABLE>
		MapWidth 50
		MapHeight 50

		% L1 = Encounter Over CounterifUStealth HardSkillTar P%id%02 else GoAutoAttack ifYesNo -3 -4 -5 else GoAvoidAttack Goto GoAutoAttack

		% Losing the encounter will set the recharge for about twelve hours.
		nu1 <if= T1 0  Return   if= L1 0  L= 1 1  LoseRenown  P= %id%01 ComTime P+ %id%01 d86400 P+ %id%01 43200>
		% Winning the encounter will increase the difficulty + number of wins.
		% If the mission-giving NPC is dead, it may also reveal the search scene.
		nu2 <if= T2 0           if= L1 0  L= 1 1  AddRenown 1 Alert 1 XPV 100 Salvage  P= %id%01 0 P+ %id%02 8  P+ %id%03 1  ifNPCDead %1% ifG P%id%02 %threat% Alert 2  SetEncounterActive %3%  WinSubPlot %plotid%>
		end <L= 1 0>

		Msg1_1 <You have defeated the mecha. %name1% will want to hear about this.>
		CMsg1_1 <ifNPCOK %1% Accept>
		Msg1_2 <You have defeated the mecha.>
		CMsg1_2 <ifNPCDead %1% Accept>
		Msg2 <Searching through one of the defeated mecha, you find the coordinates of %name3%.>
		Msg2_1 <You track the origin of these mecha back to %name3%.>

		sub
			team 1
			SetEnemy 2
			ParaX 5
			ParaY 5

			team 2
			name <Enemies>
			SetEnemy 1
			Deploy <SetSelfFaction %4%  WMecha 2 P%id%02 100>
			ParaX 45
			ParaY 45
		end
	end
	inv
		Encounter
		name <%name1%'s Mission>
		%% The BeefGate itself.
		%% This encounter will attack once per day. If the PC defeats it, then this encounter
		%% needs to be reset by E1 before it will appear again. If E1 is dead, it will reset
		%% by itself.
		update <if# P%id%01 0 else GoHide  ifG ComTime P%id%01 else GoHide  SetStat STAT_MetaVisibility 0  ShowEncounter  Goto GoSetOrders>
		% Sets this encounter's orders to Passive
		GoSetOrders <GrabSource GSetNAtt NAG_EpisodeData NAS_Orders 3>
		use <ifG StatVal STAT_MetaVisibility -1      ifNPCOK %1% else GoAutoAttack ifUStealth HardSkillTar P%id%02 else GoAutoAttack ifYesNo 1 2 3 else GoAvoidAttack Goto GoAutoAttack>
		ATTACK <ifG StatVal STAT_MetaVisibility -1   ifNPCOK %1% else GoAutoAttack ifUStealth HardSkillTar P%id%02 else GoAutoAttack ifYesNo 1 2 3 else GoAvoidAttack Goto GoAutoAttack>
		GoAutoAttack <Alert -2 Goto GoStartCombat>
		GoAvoidAttack <Alert 4  XPV 100  P= %id%01 0 P+ %id%02 8 P+ %id%03 1  UpdateProps>
		GoStartCombat <Exit Destination>
		EncounterMove 50
		Msg1 <You spot the mecha that %name1% told you about.>
		Msg2 <Approach them.>
		Msg3 <Trail them.>
		Msg4 <You collect lots of information about the movement of these mecha. %name1% will want to hear about that.>
	end



%% *ThiefHideout Content
%%
%%  A thief is hiding out somewhere. Add a hideout, and a way to access it.
%%  Most of these fragments should result in a personal scale fight.
%%
%%  The parent plot should set the plot status to this layer's ID when ready
%%  for the player to go looking. Forcing a capture will freeze the NPC.
%%  Causing the subplot to become unwinnable will also likely freeze the NPC.
%%
%%    PARAM1: Thief
%%    PARAM2: Person looking for thief; plot wiil take place in his city
%%  Returns:
%%    P%id%01 = Capture Value
%%		-1: Plot has become impossible
%%		0: Plot in progress
%%		1: NPC has been captured

Content
	name <Space Hideout>
	requires <*ThiefHideout>

	% E1 is the thief being sought; set PLACE here.
	% E2 is the bounty hunter looking for him.
	% E3 is an urban scene, for placing the encounter
	% E4 is the encounter/metascene itself
	% E5 is a character who can tell the PC where the hideout is.

	% P%id%01 = Capture Value
	% P%id%11 = Have discovered location of target

	Place1 <4 (Citizens) pass>
	Element3 <Scene Outdoors Space !Near 2>
	Element4 <Prefab>
	Place4 <3>
	Element5 <Character !Near 2>

	% If this subplot has been activated, check to make sure the informant is OK.
	Start <if= PlotStatus %plotid% %id% else %pop% if= P%id%11 0 else %pop% ifNPCDead %5% else %pop% P= %id%01 -1 Goto %pop%>

sub
	Persona 1
	Special <UNLISTED>
	greeting <ifChatNPCSurrendered else GoFirstTime Goto GoWillSurrender>
	*GoFirstTime <*IntruderGreeting&Arrest GoBargain>
	*GoBargain <*YoureUnderArrest %threat% GoWillSurrender GoWillResist na>
	*GoWillSurrender <*ISurrender&Arrest GoSurrender>
	*GoWillResist <*IDisagreeYouDie&Arrest GoAttack>
	GoAttack <SoloAttack %1% L= 2 1>
	GoSurrender <P= %id%01 1  FreezeNPC %1%>

	Persona 5
	rumor%id% <%name5% might know where %name1% is.>
	greeting <if= PlotStatus %plotid% %id% else GoChat if= P%id%11 0 else GoChat Goto GoGetInfo>
	GoChat <RevertPersona>
	*GoGetInfo <*LookingForNPC %1% GoSuccess GoFailure>
	GoSuccess <NewChat Say 1 P= %id%11 1 Memo 2>
	*GoFailure <*BrushOff&Questioning>
	Msg1 <%name1% has a microstation in %name3%. I used to do supply runs to \OPR %1% . If you're looking for \OPR %1% , that's the first place I'd check.>
	Msg2 <%name5% told you that %name1%'s microstation can be found in %name3%.>

	MetaScene 4
	special <NOEXIT>
	% L1 = Initialization Counter
	% L2 = Fight has started
	BoxMap
	MapWidth 12
	MapHeight 17
	content <Fill Sub *HIDEOUT_X na>
	Start <Print 1 if= L1 0 L= 1 1 ForceChat %1%>
	nu1 <if= T1 0 Return if= L2 1 ifNPCOK %1% FreezeNPC %1% P= %id%01 -1>
	Surrender%1% <ForceChat %1%>
	Msg1 <You enter the hideout.>
	sub
		Team 1

		Team 2
		name <Citizens>

		Room
		special <STARTHERE>
		minimap <......###..#1#...........>
		sub
			Elevator
			Destination -1
			MiniMapComponent 1
			use <Print 1 Return>
		end
	end
end
inv
	STC ENCOUNTER-DUEL
	name <%name1%'s Station>
	update <if= P%id%11 1 else GoHide  SetStat STAT_MetaVisibility 0  ShowEncounter  Goto GoSetOrders>
	ENCOUNTER_Hostile
end

Content
	name <Basic Hideout>
	requires <*ThiefHideout>

	% E1 is the thief being sought; set PLACE here.
	% E2 is the bounty hunter looking for him.
	% E3 is an urban scene, for placing the encounter
	% E4 is the encounter/metascene itself
	% E5 is a character who can tell the PC where the hideout is.

	% P%id%01 = Capture Value
	% P%id%11 = Have discovered location of target

	Place1 <4 (Citizens) pass>
	Element3 <Scene Urban !Near 2>
	Element4 <Prefab>
	Place4 <3>
	Element5 <Character !Near 2 Criminal>

	% If this subplot has been activated, check to make sure the informant is OK.
	Start <if= PlotStatus %plotid% %id% else %pop% if= P%id%11 0 else %pop% ifNPCDead %5% else %pop% P= %id%01 -1 Goto %pop%>

sub
	Persona 1
	Special <UNLISTED>
	greeting <ifChatNPCSurrendered else GoFirstTime Goto GoWillSurrender>
	*GoFirstTime <*IntruderGreeting&Arrest GoBargain>
	*GoBargain <*YoureUnderArrest %threat% GoWillSurrender GoWillResist na>
	*GoWillSurrender <*ISurrender&Arrest GoSurrender>
	*GoWillResist <*IDisagreeYouDie&Arrest GoAttack>
	GoAttack <SoloAttack %1% L= 2 1>
	GoSurrender <P= %id%01 1  FreezeNPC %1%>

	Persona 5
	rumor%id% <%name5% has had dealings with %name1% in the past.>
	greeting <if= PlotStatus %plotid% %id% else GoChat if= P%id%11 0 else GoChat Goto GoGetInfo>
	GoChat <RevertPersona>
	*GoGetInfo <*LookingForNPC %1% GoSuccess GoFailure>
	GoSuccess <NewChat Say 1 P= %id%11 1 Memo 2>
	*GoFailure <*BrushOff&Questioning>
	Msg1 <I'll tell you- %name1% used to have a hideout in %name3%. If you're looking for \OPR %1% , that's the first place I'd check.>
	Msg2 <%name5% told you that %name1%'s hideout can be found in %name3%.>

	MetaScene 4
	special <NOEXIT>
	% L1 = Initialization Counter
	% L2 = Fight has started
	BoxMap
	MapWidth 12
	MapHeight 17
	content <Fill Sub *HIDEOUT_X na>
	Start <Print 1 if= L1 0 L= 1 1 ForceChat %1%>
	nu1 <if= T1 0 Return if= L2 1 ifNPCOK %1% FreezeNPC %1% P= %id%01 -1>
	Surrender%1% <ForceChat %1%>
	Msg1 <You enter the hideout.>
	sub
		Team 1

		Team 2
		name <Citizens>

		Room
		special <STARTHERE>
		minimap <......###..#1#...........>
		sub
			Elevator
			Destination -1
			MiniMapComponent 1
			use <Print 1 Return>
		end
	end
end
inv
	STC ENCOUNTER-DUEL
	name <%name1%'s Hideout>
	update <if= P%id%11 1 else GoHide  SetStat STAT_MetaVisibility 0  ShowEncounter  Goto GoSetOrders>
	ENCOUNTER_Hostile
end

Content
	name <Hiding in Mecha>
	% The NPC is in his mecha outside of town. In order to capture him, the
	% PC will have to fight in a mecha.
	requires <*ThiefHideout>

	% E1 is the thief being sought; set PLACE here.
	% E2 is the bounty hunter looking for him.
	% E3 is an environs scene, for placing the encounter
	% E4 is the encounter/metascene itself

	Place1 <4 (Enemies) SD Enemy>
	Element3 <Scene Environs !Near 2>
	Element4 <Prefab>
	Place4 <3>

	% P%id%01 = Capture Counter
	% P%id%11 = Entered Fight Once Counter

sub
	Persona 1
	Special <UNLISTED>
	rumor%id% <%name1% is out driving around in %name3%.>
	*Greeting <*BattleIntroduction&SentToFight GoThemeExpo>
	*GoThemeExpo <*THEME_EXPO&Enemy na>

	MetaScene 4 2
	% L1 = Initialization Counter
	MapWidth 30
	MapHeight 30
	content <Fill Sub *HIDEOUT_X na>
	Start <if= L1 0 L= 1 1 P= %id%11 1 ForceChat %1%>
	nu1 <if= T1 0 Return if= L1 1  L= 1 2 ifNPCOk %1% P= %id%01 -1  ifNPCOK %1% FreezeNPC %1%>
	nu2 <if= T2 0        if= L1 1  L= 1 2 Salvage  ifNPCOk %1% P= %id%01 1   Print 2  FreezeNPC %1%>
	Msg2 <%name1% has been captured.>
	sub
		team 1
		SetEnemy 2
		ParaX 5
		ParaY 5

		team 2
		name <Enemies>
		SetEnemy 1
		update <SetSelfFaction NPCFac %1%   WMecha 2 %threat% 100>
		ParaX 25
		ParaY 25
	end
end
inv
	STC ENCOUNTER-WANDER
	name <%name1%'s Mecha>
	update <if= PlotStatus %plotid% %id% else GoHide  if= P%id%11 0 else GoHide SetStat STAT_MetaVisibility 0  Goto GoSetOrders>
	ENCOUNTER_Hostile
end



