%%
%%  *:Q_UNIQUE_[city designation]_[identifier] Content
%%  *Q_UNIQUE_[city designation]_[identifier] Content
%%
%% For guaranteed quests. Some of these will have their own PlotIDs, while
%% others will use the parent PlotID.
%%

Content
	name <McCabe's Construction Project>
	requires <*Q_UNIQUE_TOHSP_McCabe1>

	%% Param1 is McCabe
	%% Param2 is the new building under construction

	%% FAIL CONDITIONS:
	%% - McCabe dies
	update <ifNPCDead %1% LoseSubPlot %plotid%>

	% SubPlot1 is the construction problem
	SubPlot1 <*:Q_ConstructionProblem 1 2>

	sub
		Persona 1
		rumor%id% <%name1%'s reconstruction effort has hit a problem.>
		%% V%id%01 = Victory counter
		greeting <if= PlotStatus %plotid% %id% else %pop% if= V%id%01 1 else GoCheckVictory Goto %pop%>
		GoCheckVictory <ifSubPlotWon %plotid1% else GoCheckResult NewChat Say 5 History 12 QMemo %plotid% 0 P= 1 1 V= %id%01 1 AddReact 10 XPV 100 MechaPrize .%id%_mektype %threat% 4 2>
		.%id%_mektype <FCOMS MUGLE COMET HOELL>
		GoCheckResult <if# PlotStatus %plotid1% 0 else GoCheckEnemy NewChat Say 3 AddChat 3 AddChat 2>
		*GoCheckEnemy <*ENEMY_CHECK GoOfferQuest ChatNPCFac GoMakeEnemy>
		GoMakeEnemy <LoseSubPlot %plotid%>
		*GoOfferQuest <*NiceToMeetYou GoExplainQuest>
		GoExplainQuest <NewChat Say 1 AddChat 4 AddChat 5 AddChat 1>
		Result1 <NewChat Say 9 AddChat 8>
		Result2 <NewChat Say 4 LoseSubPlot %plotid%>
		Result3 <NewChat Say 6>
		Result4 <NewChat Say 7 AddChat 6 AddChat 7  AddSociable -d10    SetPlotStatus %plotid1% %id1%  QMemo %plotid% 2>
		Result5 <NewChat Say 8 AddChat 6 AddChat 7                      SetPlotStatus %plotid1% %id1%  QMemo %plotid% 2>
		result6 <NewChat Say 10  LoseSubPlot %plotid%  QMemo %plotid% 0>
		result7 <NewChat Say 11>
		Result8 <NewChat Say 13 AddChat 6 AddChat 7                     SetPlotStatus %plotid1% %id1%  QMemo %plotid% 2>
		Msg1 <As you probably know, we're still rebuilding from the damage we suffered in the impact. I'm in charge of the reconstruction efforts.>
		Msg2 <%name1% is in charge of reconstruction in Tohru Spinner. Unfortunately, one of her projects has hit a problem.>
		Msg3 <Do you have any good news for me about the reconstruction work?>
		Msg4 <This is just what we need; hasn't our city suffered enough?>
		Msg5 <I hear that you've solved our construction problem. Congratulations. Here, I'd like for you to have this mecha. It may be an industrial model but that doesn't mean that it can't kick arse.>
		Msg6 <Please do. The citizens of Tohru Spinner are counting on this.>
		Msg7 <Maybe not, but you might be interested to know that there's been a problem at one of the reconstruction sites. I'm offering a reward to anyone who can get the project back on track.>
		Msg8 <Not so well, I'm afraid. There's been a problem at one of the reconstruction sites; work has all but halted. If you could find out what's going wrong and fix it, it would be a great help to us.>
		Msg9 <Our station is close to the dusty ring, and it got hit by an asteroid that somehow made it through the sensor net. That's why you can see a big crack running across the skyfield. A lot of people got killed...>
		Msg10 <No worries. With unemployment at an all-time high, I shouldn't have any trouble finding someone more qualified than you.>
		Msg11 <Thanks. Let me know when the situation has been resolved and I'll have a special present for you.>
		Msg12 <You helped McCain with the rebuilding of Tohru Spinner.>
		Msg13 <You might be interested to know that there's been a problem at one of the reconstruction sites. I'm offering a reward to anyone who can get the project back on track.>
		Prompt1 <Wait, could you tell me about the impact?>
		Prompt2 <The reconstruction has halted.>
		CPrompt2 <ifSubPlotLost %plotid1% Accept>
		Prompt3 <I'll be back when I have something to report.>
		Prompt4 <I don't care; I don't live here.>
		CPrompt4 <if# PCHomeTown RootSceneID Accept>
		Prompt5 <How is the work coming along?>
		Prompt6 <Forget it, I'm not interested.>
		Prompt7 <Alright. I'll be back when it's fixed.>
		Prompt8 <I see.>
	end

Content
	name <First Contact>
	requires <*:Q_Unique_CAYLE_Caves>

	%% Param1 is the Cayley Caves dungeon
	% Element2 is the ghost dog
	% Element3 is the watcher

	Element2 <Prefab>
	Place2 </>
	Element3 <Prefab>
	Place3 <1 (Exorg) SD enemy>

	% P%id%01 = Ghost dog counter
	% P%id%02 = Final level message counter
	% P%id%03 = Ghost dog likes the PC

	% Get on good terms with the ghost dog, and you get on good terms with the watcher. Not that
	% it's going to help much if you plan on visiting Cayley Core.
	start <if= SceneID %1% if= P%id%02 0 P= %id%02 1 Alert %id%01 EndSubPlot %plotid%  if= P%id%03 1 TeamNeutral 3>
	Msg%id%01 <As you enter this level, you have the distinct feeling of being watched.>

	sub
		MetaScene 1
		% The encounter with the ghost dog should happen within a half
		% hour of entering the caves.
		5min <if= P%id%01 0  if= d4 1  P= %id%01 1 ifItemOK %3% Alert 11 ForceChat %2%>
		Msg11 <Suddenly, the ghostly apparition of a large dog appears before you. You hear its voice clearly through your helmet speakers.>

		Persona 2
		special <NOPLOTS NOESCAPE>
		greeting <EndChat Say 1 AddChat 1 AddChat 2 AddChat 3>
		result1 <EndChat ifG PCHeroism %threat% else GoFail Alert 4 Say 5 P= %id%03 1>
		GoFail <Alert 2 Say 3>
		result2 <Goto result1>
		result3 <Goto result1>
		Msg1 <Rowr?>
		Msg2 <The ghost dog seems to dislike the sound of your voice. It begins to fade away.>
		Msg3 <Grrr...>
		Msg4 <The ghost dog seems to like the sound of your voice. It begins to fade away.>
		Msg5 <Ruff ruff.>
		Prompt1 <Nice doggy...>
		Prompt2 <What the blazes!?>
		Prompt3 <Greetings. My name is \PC .>
	end
	inv
		NPC Citizen
		%% Just use a character blank, and fill it with our needed info
		name <Ghost Dog>
		job <Apparition>
		SDL_PORTRAIT <por_x_ghostdog.png>
		SDL_COLORS <172 225 175 172 225 175 255 255 80>
		age -20
		statline 17 19 16 22 15 20 12 14

		Monster Exorg Watcher
	end

Content
	name <Exorg Laboratory>
	requires <*:Q_Unique_CAYLE_Core>

	%% Param1 is the Cayley Core dungeon
	% Element2 is the laboratory
	% Element3 is the data slate
	% Element4 is a local public scene
	% Element5 is a specific faction
	% Element6 is the person searching for the data core
	% Element7 is a holder for the data core
	Element2 <QuestScene>
	Place2 <1>
	Element3 <Prefab>
	Place3 <7>
	Element4 <Scene Building Public>
	Element5 <Faction AEGIS>
	Element6 <NewNPC 5 4>
	Place6 </>
	Element7 <Prefab>
	Place7 <2>

	% P%id%01 = Initialization Counter
	% P%id%02 = Have accepted E6's mission

	update <if= P%id%01 0 P= %id%01 1 MoveNPC %6% %4%>
	end <ifItemDestroyed %3% else .%id%_GoCheckDeath CancelSubPlot %plotid% if= P%id%02 1 PCEnemy %6% PCFEnemy %5% FreezeNPC %6% History %id%01>
	.%id%_GoCheckDeath <ifNPCDead %6% CancelSubPlot %plotid%>

	Msg%id%01 <You failed to retrieve the dataslate for %name6%.>

	sub
		Persona 6
		rumor%id% <%name6% is looking for something from the bottom of the mine.>
		greeting <if= PlotStatus %plotid% %id% else GoChat if= P%id%02 1 else GoOfferQuest NewChat Say 1 AddChat 1 AddChat 2 AddChat 3 AddChat 4>
		GoChat <NewChat SayAnything>
		*GoOfferQuest <*DoYouWantAJob&Chara GoBriefing>
		GoBriefing <EndChat Say 2 AddChat 5>
		GoNotHere <NewChat Say 4>
		result1 <NewChat Say 3>
		result2 <ifChatNPCinPlay else GoNotHere NewChat Say 5 History 8 WinSubPlot %plotid% DeleteItem %3% CashPrize Reward %threat% 500 CustomMecha .fac %threat%>
		.fac <FCOMS RISHI HOELL MUGLE ROCKE>
		result3 <ifFactionEnemy %5% else GoR3Warn EndChat Say 6 History 9 PCEnemy %6% FreezeNPC %6% LoseSubPlot %plotid%>
		GoR3Warn <NewChat Say 7 AddChat 6 AddChat 7>
		result4 <NewChat Say 10 AddChat 8 AddChat 9>
		result5 <NewChat Say 11 AddChat 10 AddChat 11 P= %id%02 1 QMemo %plotid% 12>
		result6 <Goto result2>
		result7 <EndChat Say 13 History 9 PCEnemy %6% FreezeNPC %6% LoseSubPlot %plotid%>
		result8 <NewChat Say 14 AddChat 1 AddCHat 2 AddChat 3 AddChat 12>
		result9 <NewChat Say 15 AddChat 1 AddCHat 2 AddChat 3 AddChat 13>
		result10 <NewChat Say 16>
		result11 <NewChat Say 17 LoseSubPlot %plotid% AddRenown -d6>
		result12 <NewChat Say 18 AddChat 1 AddChat 2 AddChat 3 AddChat 9>
		result13 <NewChat Say 19 AddChat 1 AddChat 2 AddChat 3 AddChat 8>
		Msg1 <Have you found the dataslate yet?>
		Msg2 <I've been searching for information about a brilliant yet reclusive scientist who used to live on Cayley Rock. Apparently she constructed a private research station at the bottom of Old Wynter's Mine.>
		Msg3 <Come back here when you have it.>
		Msg4 <You're going to have to come to %name4% for that.>
		Msg5 <Yes, this is exactly what I wanted. The information on this dataslate will make our research far easier... in thanks, I'd like for you to have this money and a brand new mecha.>
		Msg6 <It is... regretable that you have chosen this path. My employers will be most displeased.>
		Msg7 <Are you certain that you want to do this? My employers are quite powerful, and if you displease them they would not hesitate to destroy you.>
		Msg8 <You gave the scientist's dataslate to %name6%.>
		Msg9 <You refused to give the scientist's dataslate to %name6%.>
		Msg10 <Certainly. What is it that you want to know?>
		Msg11 <I want you to find this research station and bring me back a dataslate located there. Anything else that you find in the cave is yours to keep.>
		Msg12 <%name6% in %name4% asked you to recover a dataslate from a secret research station at the bottom of Old Wynter's Mine.>
		Msg13 <Clearly so, but I think you'll find that you aren't nearly powerful enough.>
		Msg14 <She was studying the Exorg space fungi, which she believed to be alien invaders from the Andromeda galaxy. Crazy, perhaps, but defintely brilliant. Now, about that dataslate...?>
		Msg15 <I am working for a technology company that specializes in anti-fungal station defenses. Exorgs have evolved resistance to standard laser systems, making them far more difficult to exterminate than spaceworms.>
		Msg16 <Thank you. Bring me the dataslate when you have it, and I promise you'll be amply rewarded.>
		Msg17 <Understood. I will find someone else for this mission.>
		Msg18 <You believe those stories? There's no evidence for that, just a lot of conspiracy theories and wild speculation. Getting back to the subject of the dataslate...>
		Msg19 <Unlikely. Exorgs aren't particularly aggressive; I mean, they chew up power lines and will attack if you get too close, but they're no worse than regular bugs. I believe we were talking about the dataslate?>
		Prompt1 <I'm still working on it.>
		Prompt2 <I have it right here. [Give Slate]>
		CPrompt2 <ifKeyItem %3% Accept>
		Prompt3 <I found it, and I've decided to keep it.>
		CPrompt3 <ifKeyItem %3% Accept>
		Prompt4 <I'd like to ask a few questions, first.>
		Prompt5 <[Continue]>
		Prompt6 <Alright, you can have it...>
		Prompt7 <Hey, I'm quite powerful too.>
		Prompt8 <Who was this scientist?>
		Prompt9 <Who are you working for?>
		Prompt10 <I'll be back when I have it.>
		Prompt11 <Sorry, but I don't think I can do that.>
		Prompt12 <Don't you think that they might really be aliens?>
		Prompt13 <Maybe they're some kind of biomonster.>

		MetaScene 2
		name <Exorg Laboratory>
		%% Lab originally used by Jane Modo years ago
		type <Private Complex Laboratory>
		special <NOEXIT UNSAFE>
		BoxMap
		RockyTiles
		entrance <*GoDown>
		MapWidth 17
		MapHeight 17
		% V1 = First time entry
		Start <if= V1 0 else GoBeenBefore Alert 2 V= 1 1>
		GoBeenBefore <Print 1>
		Msg1 <You enter the mysterious laboratory.>
		Msg2 <At the bottom of the caves, you discover a secret laboratory. It seems to have been abandoned some time ago.>
		content <Fill Sub *STORAGE_X na>
		sub
			Team 1

			Team 2
			name <Citizens>

			Team 3
			name <Guards>
			SetAlly 2

			Room
			minimap <......#&#..&#&..#1#......>
			inv
				Elevator
				name <Airlock>
				Msg1 <You enter the airlock.>
				Destination -1
				MiniMapComponent 1
			end

			room
			minimap <......&&&..&&&..&&&......>

			room
			minimap <......&&&..&&&..&&&......>

			room
			minimap <............1............>
			inv
				STC BIOTANK
				name <Empty Specimen Tank>
				MiniMapComponent 1
				use <Print 1>
				CLUE_SCIENCE <Print 2>
				CLUE_INSIGHT <Print 2>
				Msg1 <This specimen tank is ruptured. Whatever was once in it is now long gone.>
				Msg2 <It's possible that this tank contained the Watcher you encountered earlier.>
			end

			room
			minimap <............1............>
			inv
				STC BIOTANK
				name <Specimen Tank>
				MiniMapComponent 1
				use <if= V1 0 else GoBeenBefore ifYesNo 1 2 3 V= 1 1 Alert 4 OpenInv>
				GoBeenBefore <OpenInv>
				Msg1 <You can see misty shapes floating in this specimen tank.>
				Msg2 <Open it up and reach inside.>
				Msg3 <Leave it alone.>
				Msg4 <You reach inside...>
				inv
					BeamGun 14
					name <Exorg Rifle>
					desc <A mysterious beamgun recovered from a secret laboratory.>
					CLUE_SCIENCE <Print 1>
					CLUE_INSIGHT <Print 1>
					Msg1 <This rifle appears to be made from the same material as the Exorgs themselves.>
					UsesReflexes
					Range 8
					Acc 1
					Recharge 3
					mass -9
					Biotech
					inv
						PowerSource 6
						name <Jade Disc>
						sdl_portrait <item_biskupengine.png>
						mass -8
					end
				end
			end

			room
			minimap <............1............>
			inv
				STC BIOTANK
				name <Specimen Tank>
				MiniMapComponent 1
				use <if= V1 0 else GoBeenBefore ifYesNo 1 2 3 V= 1 1 Alert 4 OpenInv>
				GoBeenBefore <OpenInv>
				Msg1 <You can see misty shapes floating in this specimen tank.>
				Msg2 <Open it up and reach inside.>
				Msg3 <Leave it alone.>
				Msg4 <You reach inside...>
				inv
					Shield 8
					name <Exorg Shield>
					desc <A mysterious shield recovered from a secret laboratory.>
					CLUE_SCIENCE <Print 1>
					CLUE_INSIGHT <Print 1>
					Msg1 <This shield appears to be made from the same material as the Exorgs themselves.>
					DefBonus 2
					mass -7
					Biotech
					AntiBeam
					sub
						EMelee 13
						name <Beam Blade>
						type <EXTEND BRUTAL>
						Recharge 3
						UsesReflexes
						inv
							PowerSource 6
							name <Jade Disc>
							mass -8
							sdl_portrait <item_biskupengine.png>
						end
					end
				end
			end
		end

		MetaScene 7
		% Hold the bedroom, which holds the endtable, which holds the data slate
		sub
			Room
			minimap <...........321..###......>
			desig <HOME>
			inv

				STC BED-1
				MiniMapComponent 2

				STC ENDTABLE-1
				PDir 6
				use <OpenInv>
				MiniMapComponent 3
				inv
					item Antiseptic Ointment
					item Super Glue
					item Biotech Lab Set
				end
			end
		end
	end
	inv
		item Mediabook
		name <Data Slate>
		desc <A data slate previously owned by whoever built the lab in Cayley Core. It's marked with the initials "JM".>
		% V1 = Have overcome encryption
		use <ifYesNo 1 2 3 moretext .fname>
		.fname <TEXT_CCLJMD.txt>
		CLUE_CODEBREAKING <if= V1 0 else GoAlreadyBroken ifCodeBreaking HardSkillTar 100 else use Mental Mental Alert 4 XPV 100   SkillXP NAS_Medical 200  SkillXP NAS_Repair 200  SkillXP NAS_Science 200   V= 1 1>
		GoAlreadyBroken <Print 5>
		Msg1 <This dataslate contains someone's diary. Do you want to read it?>
		Msg2 <Yes I do.>
		Msg3 <No, thanks.>
		Msg4 <You discover an encrypted file containing detailed anatomical and biochemical information about the Exorgs. Reading it makes your head hurt.>
		Msg5 <You've already viewed the encrypted file.>

		STC ENDTABLE-1
		PDir 6
		use <OpenInv>
	end

