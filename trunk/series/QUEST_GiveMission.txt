%%
%% *:GiveMission Content
%%
%% An NPC will give the PC a mission to complete. When the mission is
%% completed, the QuestStatus of this subquest will be set to -1. If
%% the mission is rendered uncompletable, the QuestStatus will be -2.
%%
%% Param1 is the NPC providing the mission
%%   note: Persona 1 must have a .%id%_GoInit script
%%	The parent quest must handle E1's reaction to
%%	successfully completing/losing this subquest,
%%	though this SQ should have a reminder message
%%	in Persona 1.
%%
%% Set REQUIRES to *:DebugMission to load into the debugging stub.

Content
	name <Recharge Service>
	desc <The PC will be sent to replace the batteries in a spore collector.>
	requires <*:GiveMission "Spinner" (1:ACADE|1:CORPO)>

	% E1 is the NPC offering the mission
	% E2 is the machine to be recharged
	% E3 is the dungeon entrance
	% E4 is the very special isotropic battery
	Element2 <Prefab>
	Scene2 <New *Dungeon.AsteroidCave>

	Element3 <Prefab>
	Scene3 <Space Environs>

	Element4 <Prefab>
	Place4 </>

	sub
		Persona 1
		Greeting <if= QuestStatus %qid% %id% else %pop% NewChat Say %id%01>
		.%id%_GoInit <SetQuestStatus %qid% %id% NewChat Say %id%02 QMemo %qid% %id%03 GiveItem %4%>
		Msg%id%01 <The spore collector is still offline. Please bring the isotropic battery to the asteroid.>
		Msg%id%02 <We've been researching the space fungus living on a nearby asteroid. Unfortunately, the automatic spore collector is running low on power. I want you to take this isotropic battery there and install it.>
		Msg%id%03 <%name1% asked you to replace the battery in the spore collector in an asteroid in \SCENE %s3% .>

		MetaScene 1
		start <if= QuestStatus %qid% %id% else %pop% ifItemDestroyed %4% else %pop% SetQuestStatus %qid% -2 Goto %pop%>

		MetaScene 2
		end <if= QuestStatus %qid% %id% else %pop% ifItemDestroyed %2% else %pop% SetQuestStatus %qid% -2 Goto %pop%>
	end
	inv
		STC COMPUTER-1
		name <Spore Extractor>
		use <Print 1 OpenInv ifSelfHasItem %4% SetQuestStatus %qid% -1 QMemo %prev_qid% 3 DeleteItem %4% Print 2 XPV 100>
		Msg1 <You open the spore collector access panel.>
		Msg2 <The spore collector starts working again.>
		Msg3 <You have completed %name1%'s task.>

		STC QUEST-MAPMARKER-AUTO-STATIONARY
		name <%name1%'s Asteroid>
		desig <Entrance %s2%>

		Treasure
		name <Isotropic Battery>
		Fudge 5000
		desc <You need to install this battery in the spore collector.>
	end

Content
	name <Go Beat Rishiri>
	desc <What could be better than blowing up some Rishiri mecha?>
	requires <*:GiveMission 1:CRIHN ("RISHI"|"ROCKE")>

	% E1 is the NPC offering the mission
	% E2 is the encounter that is the mission
	Element2 <Prefab>
	Scene2 <Urban>

	sub
		Persona 1
		Greeting <if= QuestStatus %qid% %id% else %pop% NewChat Say %id%01>
		.%id%_GoInit <SetQuestStatus %qid% %id% NewChat Say %id%02 QMemo %qid% %id%03>
		Msg%id%01 <The mecha force in \SCENE %s2% hasn't been destroyed yet. What are you waiting for?>
		Msg%id%02 <A Rishiri Spinner mecha force has been training in \SCENE %s2% ; seems like they're gearing up to sweep the dusty ring. I want you to find this mecha force and destroy it. Leave no survivors.>
		Msg%id%03 <%name1% asked you to locate and eliminate the Rishiri mecha force currrently training in \SCENE %s2% .>

		MetaScene 1
		end <if= QuestStatus %qid% %id% else %pop% ifNPCDead %1% else %pop% SetQuestStatus %qid% -2 Goto %pop%>
	end
	inv
		Encounter
		name <Rishiri Mecha Force>
		Special <NoMSID>
		% V1 = Visibility Clock.
		%      If ComTime > V1 and QuestStatus %qid% = %id%, encounter is active
		update <if= QuestStatus %qid% %id% else GoHide ifG ComTime V1 else GoHide  SetStat STAT_MetaVisibility 0  ShowEncounter  Goto GoSetOrders>
		GoSetOrders <GrabSource GSetNAtt NAG_EpisodeData NAS_Orders 3>
		use <ifG StatVal STAT_MetaVisibility -1  Print -1  Goto GoStartCombat>
		ATTACK <ifG StatVal STAT_MetaVisibility -1    ifUStealth 15 else GoAutoAttack ifYesNo -3 -4 -5 else GoAvoidAttack Goto GoAutoAttack>
		GoAutoAttack <Alert -2 Goto GoStartCombat>
		GoAvoidAttack <Print -6 AddSociable -1>
		GoStartCombat <V= 1 ComTime V+ 1 86400  SavePos Dynamic 2 %threat% 100 .nu1 .nu2 ComposeD Msg1 .Msg1 ComposeD Msg2 .Msg2 DynaFaction 11>
		.nu1 <if= T1 0  Return   if= L2 0  L= 2 1  AddRenown -5  ItemVar= %2% 1 ComTime ItemVar+ %2% 1 d86400 ItemVar+ %2% 1 43200>
		.nu2 <if= T2 0           if= L2 0  L= 2 1  XPV 100  AddRenown 1   Alert 1  Salvage  SetQuestStatus %qid% -1 QMemo %prev_qid% 2 DeleteItem %2%>
		.msg1 <You have defeated the Rishiri mecha force.>
		.msg2 <You have completed %name1%'s task.>
		EncounterMove 50
	end

Content
	name <Go Kill Rats>
	desc <The PC will be sent to exterminate a basement. Very posh.>
	requires <*:GiveMission (1:CRAFT|1:CORPO|1:TRADE)>

	% E1 is the NPC offering the mission
	% E2 is the extermination basement
	% E3 is the bassement entrance
	Scene2 <New *ExterminationBasement>
	Scene3 <Building Mall Public !Okay 1>

	sub
		Persona 1
		Greeting <if= QuestStatus %qid% %id% else %pop% NewChat Say %id%01>
		.%id%_GoInit <SetQuestStatus %qid% %id% NewChat Say %id%02 QMemo %qid% %id%03 SceneVar= %s2% 11 1 UpdateProps>
		Msg%id%01 <The warehouse at \SCENE %s3% is still infested. I can't reopen my shop until it's been cleaned out.>
		Msg%id%02 <My warehouse in \SCENE %s3% has been infested with rats... or something. I'd like for you to go down there and clean it out.>
		Msg%id%03 <%name1% asked you to clean out \PPR %1% warehouse in \SCENE %s3% .>

		MetaScene 2
		% L11 = Can enter storehouse
		End <if= QuestStatus %qid% %id% else %pop% if= L1 1 else %pop% SetQuestStatus %qid% -1 QMemo %prev_qid% 11 Goto %pop%>
		Msg11 <You have completed %name1%'s task.>

		MetaScene 3
		sub
			room
			special <SHAREDPALETTE>
			minimap <#...##.2.##...###+###...#>
			sub
				Door
				update <if= V1 0 else GoCheckQuest V= 1 1 SetStat STAT_Lock %sktar_hard% Goto GoCheckQuest>
				GoCheckQuest <if= SceneVar %s2% 11 1  SetStat STAT_Lock 0>
			end
			inv
				TrapDoor
				MiniMapComponent 2
				desig <ENTRANCE %s2%>
				use <if= SceneVar %s2% 11 1 else GoNotYet Print 1 Exit Destination>
				GoNotYet <Print 11>
				Msg11 <You don't want to go down there. It's dark and there are scary noises.>
			end
		end
	end

Content
	name <Go Beat Thieves>
	desc <Some mecha have been stolen, and are galavanting around. See what you can do.>
	requires <*:GiveMission (1:POLIC|1:CRAFT)>
	special <REUSABLE>

	% E1 is the NPC offering the mission
	% E2 is the encounter that is the mission
	Element2 <Prefab>
	Scene2 <Environs>

	sub
		Persona 1
		Greeting <if= QuestStatus %qid% %id% else %pop% NewChat Say %id%01>
		.%id%_GoInit <SetQuestStatus %qid% %id% NewChat Say %id%02 QMemo %qid% %id%03>
		Msg%id%01 <Those mecha thieves have not yet been brought to justice.>
		Msg%id%02 <Recently, a number of mecha have been stolen. The thieves are thought to be somewhere in the \SCENE %s2% area. If you could catch them, I'd have a reward for you.>
		Msg%id%03 <%name1% asked you to catch a gang of mecha thieves in \SCENE %s2% .>

		MetaScene 1
		end <if= QuestStatus %qid% %id% else %pop% ifNPCDead %1% else %pop% SetQuestStatus %qid% -2 Goto %pop%>
	end
	inv
		Encounter
		name <Stolen Mecha>
		Special <NoMSID>
		% V1 = Visibility Clock.
		%      If ComTime > V1 and QuestStatus %qid% = %id%, encounter is active
		update <if= QuestStatus %qid% %id% else GoHide ifG ComTime V1 else GoHide  SetStat STAT_MetaVisibility 0  Goto GoSetOrders>
		GoSetOrders <GrabSource GSetNAtt NAG_EpisodeData NAS_Orders 3>
		use <ifG StatVal STAT_MetaVisibility -1  Print -1  Goto GoStartCombat>
		ATTACK <ifG StatVal STAT_MetaVisibility -1    ifUStealth 15 else GoAutoAttack ifYesNo -3 -4 -5 else GoAvoidAttack Goto GoAutoAttack>
		GoAutoAttack <Alert -2 Goto GoStartCombat>
		GoAvoidAttack <Print -6 AddSociable -1>
		GoStartCombat <V= 1 ComTime V+ 1 86400  SavePos Dynamic 2 %threat% 100 .nu1 .nu2 ComposeD Msg1 .Msg1 ComposeD msg2 .msg2 DynaFaction 0>
		.nu1 <if= T1 0  Return   if= L2 0  L= 2 1  AddRenown -5  ItemVar= %2% 1 ComTime ItemVar+ %2% 1 d86400 ItemVar+ %2% 1 43200>
		.nu2 <if= T2 0           if= L2 0  L= 2 1  XPV 100  AddRenown 1   Alert 1  SetQuestStatus %qid% -1 QMemo %prev_qid% 2 DeleteItem %2%>
		.msg1 <You have defeated the mecha thieves.>
		.msg2 <You have completed %name1%'s task.>
		EncounterMove 50
	end

Content
	name <Go Beat Invaders>
	desc <Some unauthorized mecha have shown up in the city. See what you can do.>
	requires <*:GiveMission (1:MILIT|1:POLIT|1:ADVEN)>
	special <REUSABLE>

	% E1 is the NPC offering the mission
	% E2 is the encounter that is the mission
	Element2 <Prefab>
	Scene2 <Urban>

	sub
		Persona 1
		Greeting <if= QuestStatus %qid% %id% else %pop% NewChat Say %id%01>
		.%id%_GoInit <SetQuestStatus %qid% %id% NewChat Say %id%02 QMemo %qid% %id%03>
		Msg%id%01 <The infiltrators in \SCENE %s2% have not yet been dealt with.>
		Msg%id%02 <A team of unknown mecha has been detected in \SCENE %s2% . We don't yet know their intentions, but they must be stopped before they have a chance to do any damage.>
		Msg%id%03 <%name1% asked you to locate and eliminate some mecha infiltrators in \SCENE %s2% .>

		MetaScene 1
		end <if= QuestStatus %qid% %id% else %pop% ifNPCDead %1% else %pop% SetQuestStatus %qid% -2 Goto %pop%>
	end
	inv
		Encounter
		name <Invaders>
		Special <NoMSID>
		% V1 = Visibility Clock.
		%      If ComTime > V1 and QuestStatus %qid% = %id%, encounter is active
		update <if= QuestStatus %qid% %id% else GoHide ifG ComTime V1 else GoHide  SetStat STAT_MetaVisibility 0  Goto GoSetOrders>
		GoSetOrders <GrabSource GSetNAtt NAG_EpisodeData NAS_Orders 3>
		use <ifG StatVal STAT_MetaVisibility -1  Print -1  Goto GoStartCombat>
		ATTACK <ifG StatVal STAT_MetaVisibility -1    ifUStealth 15 else GoAutoAttack ifYesNo -3 -4 -5 else GoAvoidAttack Goto GoAutoAttack>
		GoAutoAttack <Alert -2 Goto GoStartCombat>
		GoAvoidAttack <Print -6 AddSociable -1>
		GoStartCombat <V= 1 ComTime V+ 1 86400  SavePos Dynamic 2 %threat% 100 .nu1 .nu2 ComposeD Msg1 .Msg1 ComposeD msg2 .msg2 DynaFaction 0>
		.nu1 <if= T1 0  Return   if= L2 0  L= 2 1  AddRenown -5  ItemVar= %2% 1 ComTime ItemVar+ %2% 1 d86400 ItemVar+ %2% 1 43200>
		.nu2 <if= T2 0           if= L2 0  L= 2 1  XPV 100  AddRenown 1   Alert 1  Salvage  SetQuestStatus %qid% -1 QMemo %prev_qid% 2 DeleteItem %2%>
		.msg1 <You have defeated the invaders.>
		.msg2 <You have completed %name1%'s task.>
		EncounterMove 50
	end

Content
	name <Go Beat Bandits>
	desc <Some bandits have been attacking truckers. See what you can do.>
	requires <*:GiveMission (1:CORPO|1:TRADE|1:LABOR)>
	special <REUSABLE>

	% E1 is the NPC offering the mission
	% E2 is the encounter that is the mission
	Element2 <Prefab>
	Scene2 <Environs>

	sub
		Persona 1
		Greeting <if= QuestStatus %qid% %id% else %pop% NewChat Say %id%01>
		.%id%_GoInit <SetQuestStatus %qid% %id% NewChat Say %id%02 QMemo %qid% %id%03>
		Msg%id%01 <The bandits who have been attacking our truckers are still on the loose.>
		Msg%id%02 <Several of our truckers have been attacked by bandits in \SCENE %s2% . If you could locate these bandits and eliminate them, I'd have a reward for you.>
		Msg%id%03 <%name1% asked you to locate some bandits in \SCENE %s2% that have been attacking truckers.>

		MetaScene 1
		end <if= QuestStatus %qid% %id% else %pop% ifNPCDead %1% else %pop% SetQuestStatus %qid% -2 Goto %pop%>
	end
	inv
		Encounter
		name <Bandits>
		Special <NoMSID>
		% V1 = Visibility Clock.
		%      If ComTime > V1 and QuestStatus %qid% = %id%, encounter is active
		update <if= QuestStatus %qid% %id% else GoHide ifG ComTime V1 else GoHide  SetStat STAT_MetaVisibility 0  Goto GoSetOrders>
		GoSetOrders <GrabSource GSetNAtt NAG_EpisodeData NAS_Orders 3>
		use <ifG StatVal STAT_MetaVisibility -1  Print -1  Goto GoStartCombat>
		ATTACK <ifG StatVal STAT_MetaVisibility -1    ifUStealth 15 else GoAutoAttack ifYesNo -3 -4 -5 else GoAvoidAttack Goto GoAutoAttack>
		GoAutoAttack <Alert -2 Goto GoStartCombat>
		GoAvoidAttack <Print -6 AddSociable -1>
		GoStartCombat <V= 1 ComTime V+ 1 86400  SavePos Dynamic 2 %threat% 100 .nu1 .nu2 ComposeD Msg1 .Msg1 ComposeD msg2 .msg2 DynaFaction 0>
		.nu1 <if= T1 0  Return   if= L2 0  L= 2 1  AddRenown -5  ItemVar= %2% 1 ComTime ItemVar+ %2% 1 d86400 ItemVar+ %2% 1 43200>
		.nu2 <if= T2 0           if= L2 0  L= 2 1  XPV 100  AddRenown 1   Alert 1  Salvage  SetQuestStatus %qid% -1 QMemo %prev_qid% 2 DeleteItem %2%>
		.msg1 <You have defeated the bandits.>
		.msg2 <You have completed %name1%'s task.>
		EncounterMove 50
	end


%%
%% *:DebugGiveMission Content
%%
%% Loads a mission into the Cavalier's Club for easy debugging.
%%

Content
	requires <*:DebugGiveMission>
	desc <The NPC will give the PC a mission, to be handled by a "GiveMission" subquest.>

	% E1 is the person who will be giving the mission.
	Element1 <NewNPC 0 0>
	Scene1 <CavClub>
	Team1 <Citizens>
	TeamData1 <Ally Pass>

	% SubQuest1 is the mission.
	Quest1 <*:DebugMission 1>

	sub
		Persona 1
		rumor0 <%name1% needs a cavalier for a mission of some kind.>
		greeting <if= QuestStatus %qid% %id% else GoCheckFirst if= QUestStatus %qid1% -1 else GoCheckLoss NewChat Say 1 SetQuestStatus %qid% -1>
		GoCheckLoss <if= QuestStatus %qid1% -2 else GoCheckFirst SetQuestStatus %qid% -2 Goto GoEndInLoss>
		*GoEndInLoss <*MissionWasFailure na na na>
		GoCheckFirst <if= QuestStatus %qid% 0 else GoChat Goto GoOfferQuest>
		*GoOfferQuest <*DoYouWantAJob GoStartQuest>
		GoStartQuest <SetQuestStatus %qid% %id% Goto .%id1%_GoInit>
		GoChat <NewChat SayAnything>
		Msg1 <I hear that you succeeded. The debugging of the mission is now over.>
	end




