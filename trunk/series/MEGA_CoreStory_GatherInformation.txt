%% *:CS_GatherInformation Content
%%
%% In this component, the PC will be able to gain some information via a difficult source.
%% This component will almost certainly change the story context.
%%
%% The Param1 NPC must have a persona which calls the following script:
%%   .%id%_GoInform
%% This script tells the PC about the situation, setting up the rest of this
%% subplot. The SubPlotID must be set separately.
%%
%% When this subplot concludes, it sets one of the following triggers:
%%  .%id%_%plotid%_GoWin
%%  .%id%_%plotid%_GoLoss
%%
%% This is a MAIN COURSE subplot. Favored by: POLIT, MEDIA, ACADE
%%
%%
%%  Param1: The NPC who will tell the PC about the situation.
%%          After introducing the component, this NPC will serve no further purpose
%%          in this narrative thread.
%%

Content
	name <Ex-Lover vs Ex-Partner>
	desc <The enemy's ex-lover is on the run from the enemy's ex-partner.>
	requires <*:CS_GatherInformation E:A.sr_ E:M.--->
	changes <E:M>
	Size 7

	%% The centerpiece of this component is an encounter in which the PC can help
	%% defend the ex-lover against the ex-partner. It should be possible, if the PC
	%% plays the cards right, for the encounter to be won without a shot being
	%% fired.

	% E1 is the person who tells the PC.
	% E2 is the ex-lover
	% E3 is the ex-partner
	% E4 is an outdoors scene for the duel
	% E5 is the encounter for the duel
	% E6 is E3's secret which may be revealed
	% E7 is the enemy, which must be grabbed because it's going to get modified
	Element2 <NewNPC  0 -7>
	Place2 </>
	Element3 <NewNPC -2 -7>
	Place3 </>
	Element4 <Scene Outdoors !Near -7>
	Element5 <Prefab>
	Place5 <4>
	Element6 <Prefab>
	Element7 <Grab 1>
	Place7 </>

	% FAIL CONDITIONS
	% - LocateDuel fails

	% P%id%01 = Initialization Counter
	% P%id%02 = Decimation Counter
	% P%id%03 = Learn Secret Counter
	% P%id%04 = Have won the encounter

	% At initialization, move and level both of the characters, then activate
	% the three subplots.
	update <if= p%id%01 0 p= %id%01 1 NPCLevel %2% StoryDL NPCLevel %3% StoryDL MoveNPC %2% %5% SetNPCTeam %2% 3 MoveNPC %3% %5% SetNPCTeam %3% 2 SetPlotStatus %plotid1% %id1% SetPlotStatus %plotid2% %id2% SetPlotStatus %plotid3% %id3%>
	start <ifSubPlotLost %plotid1% CancelSubPlot %plotid2% CancelSubPlot %plotid3% History %id%01 LoseSubPlot %plotid% Trigger0 .%id%_%plotid%_GoLoss>

	.%id2%_%plotid2%_GoDecimation <P= %id%02 1>
	.%id3%_%plotid3%_GoLearnSecret <P= %id%03 1>

	Msg%id%01 <You failed to protect %name2% from %name3%.>

	%% SubPlot1 is the LocateDuel task
	%% SubPlot2 is the GainAdvantageVsNPC one
	%% SubPlot3 is the ability to learn E3's secret
	SubPlot1 <*:CS_LocateDuel 4 5 2 3>
	SubPlot2 <*:CS_GainAdvantageVsNPC&Decimation 3>
	SubPlot3 <*:CS_LearnSecretAboutNPC 6 3>

	sub
		Persona 1
		.%id%_GoInform <NPCConGen %2% %7% NewChat Say %id%01 StoryNote %id%02>
		Msg%id%01 <%name7%'s ex-lover %name2% is in town; \SPR %2% 's on the run from %name7%'s partner %name3%. I guess their breakup must have been pretty rough.>
		Msg%id%02 <You learned that %name7%'s partner %name3% is trying to kill \PPR %7% ex-lover %name2%.>


		Persona 2
		% E2 will speak with the PC after the combat is won; before then, no special message.
		special <UNLISTED NOESCAPE>
		greeting <if= p%id%04 1 else GoNotNow  EndChat Say 2 AddCHat 1>
		GoNotNow <EndChat Say 1>
		GoWin <AddChat 2 XPV 100   WinSubPlot %plotid%   Trigger0 .%id%_%plotid%_GoWin>
		*result1 <*CS_ExplainEnemyNature&Lover GoWin>
		result2 <EndChat Say 3 PCAlly %2% FreezeNPC %2%>
		Msg1 <We shouldn't be talking now; we're in the middle of combat!>
		Msg2 <Thank you! I couldn't have defeated %name3% without your help.>
		Msg3 <No, that's why \SPR %7% broke up with me. I appreciate your help, \PC . Maybe someday I'll be able to return the favor.>
		Prompt1 <No problem. I was hoping you could tell me about %name7%.>
		Prompt2 <Is that why you broke up with \OPR %7% ?>


		Persona 3
		% E3 will speak with the PC at the beginning of combat. If the PC has learned the secret, it's
		% possible through a series of skill rolls to cause E3 to flee without firing a shot.
		special <UNLISTED>
		% V1 = One time only counter
		greeting <if= v1 0 else GoThemeInfo V= 1 1 EndChat Say 1 AddChat 1 AddChat 2 AddChat 3>
		*GoThemeInfo <*THEME_EXPO&Enemy NA>
		result1 <Goto GoThemeInfo>
		result2 <Goto GoThemeInfo>
		result3 <EndChat Say 2 AddChat 4 AddChat 5 AddChat 6>
		result4 <EndChat Say 3 AddChat 7 AddChat 8>
		result5 <Goto result4>
		result6 <Goto GoThemeInfo>
		result7 <ifConversation SkillTar &StoryDL else GoR7Fail EndCHat Say 4 Print 5 StoryNote 6 Retreat 2 FreezeNPC %3% PCEnemy %3%  L= 1 1   P= %id%04 1 ForceChat %2%>
		GoR7Fail <EndCHat Say 7>
		result8 <Goto GoThemeInfo>
		Msg1 <\PC , I should have expected to see you here. I suppose you plan on defending %name2%?>
		Msg2 <What do you mean by that!? I... I'm just protecting %name7%'s interests.>
		Msg3 <What do you know about love!? What do you know about anything!? I'm doing this because it's what I have to do...>
		Msg4 <You... you're right. I'll leave here today, but know this- I won't forgive you, and %name7% will be mine!>
		Msg5 <%name3% leaves the area.>
		Msg6 <You talked %name3% into leaving %name2% alone.>
		Msg7 <You're wrong! I'll prove that you're wrong! Neither you nor %name2% can stop our love!>
		Prompt1 <That's right. That's just the kind of pilot I am.>
		Prompt2 <I'm more interested in defeating you.>
		Prompt3 <Does %name7% know about your broken heart?>
		CPrompt3 <if# p%id%03 0 Accept>
		Prompt4 <Pathetic. You think loving %name7% gives you a license to kill?>
		CPrompt4 <ifIntimidation SkillTar StoryDL Accept>
		Prompt5 <%name7% doesn't even know about this, does \SPR %7% ?>
		CPrompt5 <ifInvestigation SkillTar StoryDL Accept>
		Prompt6 <Well then, I'm going to protect %name2%. Let's fight.>
		Prompt7 <Killing %name2% won't make \OPR %7% love you.>
		Prompt8 <I can see it's useless to even try talking with you.>


		MetaScene 5 2
		% This is where the PC will be able to try defending E2 from E3. Succeed, and
		% E3 will tell the PC some things about the enemy. Fail, and, well... you fail.
		MapWidth 50
		MapHeight 50

		% L1 = Encounter Over Counter
		% L2 = Initialization Counter

		Start <if= L2 0 L= 2 1   L= 1 0   Alert 1 Monologue %2% 2 ForceChat %3% CancelSubPlot %plotid2% CancelSubPlot %plotid3%>
		nu1 <if= T1 0   Return   if= V1 0 V= 1 1   Goto GoLose>
		nu2 <if= T2 0   if= V1 0 V= 1 1   ifG T3 0 else GoLose  P= %id%04 1 History 4 ForceChat %2%>
		GoLose <Alert 3 StoryNote 3 AddRenown -1  Trigger0 .%id%_%plotid%_GoLoss LoseSubPlot %plotid% ifNPCOK %3% PCEnemy %3%>
		end <SetEncounterInactive %5%>

		Msg1 <You find %name3% about to attack %name2%.>
		Msg2 <Help! I'm being attacked!>
		Msg3 <You failed to protect %name2% from %name3%.>
		Msg4 <You defeated %name3%.>

		sub
			team 1
			SetEnemy 2
			SetAlly 3
			ParaX 5
			ParaY 5

			team 2
			SetEnemy 1 3
			% Team 2 is the enemy side. If the PC earned the Decimation advantage, it will consist
			% only of E3; otherwise it's E3 and a bunch of mecha. Ouch.
			Deploy <if= PlotStatus %plotid% %id% if= p%id%02 0   SetSelfFaction &EnemyFac   WMecha 2 StoryDL 100>
			ParaX 25
			ParaY 25

			team 3
			SetEnemy 2
			SetAlly 1
			ParaX 45
			ParaY 45
		end

	end
	inv
		stc CORE-ACTIVATABLE
		name <%name2% and %name3%>

		Secret
		Msg <%name3% hates %name2% because \SPR %3% was secretly in love with %name7%.>
	end


